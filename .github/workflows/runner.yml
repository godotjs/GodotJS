name: ğŸ”— GHA

# Only run pipeline on open pull_requests and main + releases
# we don't need it on every push and some parameters are not available for push only
on:
  pull_request:
  push:
    branches:
      - "main"

concurrency:
  group: ${{ github.workflow }}|${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  environment:
    name: ğŸŒ³ Set Environment
    uses: ./.github/workflows/misc_environment.yml

  changesets:
    permissions:
      contents: write
      pull-requests: write
    name: ğŸ”„ Changesets
    uses: ./.github/workflows/misc_changesets.yml

  engine-version-build:
    name: âš™ï¸ Build Godot Version with GodotJS
    needs: [environment, changesets]
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 4.4
            version_ref: 4.4
          - version: 4.5
            version_ref: 4.5
    uses: ./.github/workflows/build_engine_version.yml
    with:
      version: ${{ matrix.version }}
      version_ref: ${{ matrix.version_ref }}
      tests: ${{ needs.changesets.outputs.publish == 'false' }}

  builds-done:
    name: ğŸ Builds Done
    needs: [engine-version-build, environment]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ Check if all builds are done
        run: |
          echo "ğŸ All builds done"
        shell: bash

  release:
    name: ğŸ¦… Release
    needs: [changesets, engine-version-build, environment, builds-done]
    if: needs.changesets.outputs.publish == 'true'
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/misc_release.yml
    secrets: inherit
    strategy:
      fail-fast: true
      matrix:
        include:
          - version: 4.4
          - version: 4.5
    with:
      version: ${{ matrix.version }}
