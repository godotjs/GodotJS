name: 🔗 GHA

# Only run pipeline on open pull_requests and main + releases
# we don't need it on every push and some parameters are not available for push only
on:
  pull_request:
  push:
    branches:
      - "main"
  schedule:
    - cron: "2 0 * * 0" # Sunday after midnight to trigger a release

concurrency:
  group: ${{ github.workflow }}|${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  environment:
    name: 🌳 Set Environment
    uses: ./.github/workflows/misc/environment.yml

  android-build:
    name: 🤖 Android
    uses: ./.github/workflows/builds/android.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  ios-build:
    name: 🍏 iOS
    uses: ./.github/workflows/builds/ios.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  linux-build:
    name: 🐧 Linux
    uses: ./.github/workflows/builds/linux.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  macos-build:
    name: 🍎 macOS
    uses: ./.github/workflows/builds/macos.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  windows-build:
    name: 🏁 Windows
    uses: ./.github/workflows/builds/windows.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  web-build:
    name: 🌐 Web
    uses: ./.github/workflows/builds/web.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  checks-done:
    if: ${{ always() }}
    name: ✅ Check builds
    runs-on: ubuntu-latest
    steps:
      - name: 🎉 Checks done
        run: |
          resultWebBuild="${{ needs.web-build.result }}"
          resultWindowsBuild="${{ needs.windows-build.result }}"          
          resultMacosBuild="${{ needs.macos-build.result }}"
          resultLinuxBuild="${{ needs.linux-build.result }}"
          resultIosBuild="${{ needs.ios-build.result }}"
          resultAndroidBuild="${{ needs.android-build.result }}"
          if [[ 
            $resultWebBuild == "success" && 
            $resultWindowsBuild == "success" && 
            $resultMacosBuild == "success" && 
            $resultLinuxBuild == "success" && 
            $resultIosBuild == "success" && 
            $resultAndroidBuild == "success" 
          ]]; 
          then
            echo "🎉 All builds were successful."
            exit 0
          else
            echo "😥 Some builds were failing."
            exit 1
          fi
    needs:
      [
        web-build,
        windows-build,
        macos-build,
        linux-build,
        ios-build,
        android-build
      ]

  release:
    name: 🦅 Release
    if: needs.environment.outputs.publish == 'true'
    needs: [ checks-done, environment ]
    uses: ./.github/workflows/misc/release.yml
    secrets: inherit
    with:
      version: ${{ needs.environment.outputs.version }}
      v8: ${{ needs.environment.outputs.v8 }}
