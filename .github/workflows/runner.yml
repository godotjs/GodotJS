name: 🔗 GHA

# Only run pipeline on open pull_requests and main + releases
# we don't need it on every push and some parameters are not available for push only
on:
  pull_request:
  push:
    branches:
      - "main"
  schedule:
    - cron: "2 0 * * 0" # Sunday after midnight to trigger a release

concurrency:
  group: ${{ github.workflow }}|${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  environment:
    name: 🌳 Set Environment
    uses: ./.github/workflows/misc_environment.yml

  changesets:
    if: github.event_name != 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    name: 🔄 Changesets
    uses: ./.github/workflows/misc_changesets.yml

  engine-version-build:
    name: ⚙️ Build Godot Version with GodotJS
    needs: environment
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 4.4
            version_ref: 4.4
          - version: 4.5
            version_ref: 4.5
    uses: ./.github/workflows/build_engine_version.yml
    with:
      v8: ${{ needs.environment.outputs.v8 }}
      version: ${{ matrix.version }}
      version_ref: ${{ matrix.version_ref }}

  release:
    name: 🦅 Release
    needs: [ changesets, engine-version-build, environment ]
    if: needs.changesets.outputs.publish == 'true'
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/misc_release.yml
    secrets: inherit
    with:
      version: ${{ needs.environment.outputs.version }}
      v8: ${{ needs.environment.outputs.v8 }}
