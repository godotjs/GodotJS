name: ğŸ”— GHA

# Only run pipeline on open pull_requests and main + releases
# we don't need it on every push and some parameters are not available for push only
on:
  pull_request:
  push:
    branches:
      - "main"
  schedule:
    - cron: "2 0 * * 0" # Sunday after midnight to trigger a release

concurrency:
  group: ${{ github.workflow }}|${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  environment:
    name: ğŸŒ³ Set Environment
    uses: ./.github/workflows/misc_environment.yml

  changesets:
    if: github.event_name != 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    name: ğŸ”„ Changesets
    uses: ./.github/workflows/misc_changesets.yml

  engine-version-build:
    name: âš™ï¸ Build Godot Version with GodotJS
    needs: environment
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 4.4
            version_ref: 4.4
          - version: 4.5
            version_ref: 4.5
    uses: ./.github/workflows/build_engine_version.yml
    with:
      v8: ${{ needs.environment.outputs.v8 }}
      version: ${{ matrix.version }}
      version_ref: ${{ matrix.version_ref }}

  builds-done:
    name: ğŸ Builds Done
    needs: [ engine-version-build, environment ]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ Check if all builds are done
        run: |
          echo "ğŸ All builds done"
        shell: bash

  release:
    name: ğŸ¦… Release
    needs: [ changesets, engine-version-build, environment, builds-done ]
    if: needs.changesets.outputs.publish == 'true'
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/misc_release.yml
    secrets: inherit
    strategy:
      fail-fast: true
      matrix:
        include:
          - version: 4.4
          - version: 4.5
    with:
      version: ${{ matrix.version }}
      v8: ${{ needs.environment.outputs.v8 }}
