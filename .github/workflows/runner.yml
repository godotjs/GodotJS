name: ğŸ”— GHA

# Only run pipeline on open pull_requests and main + releases
# we don't need it on every push and some parameters are not available for push only
on:
  pull_request:
  push:
    branches:
      - "main"
  release:
    types: [ published ]

concurrency:
  group: ${{ github.workflow }}|${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  environment:
    name: ğŸŒ³ Set Environment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versions.outputs.version }}
      v8: ${{ steps.versions.outputs.v8 }}
    steps:
      - name: ğŸ· Set Versions
        id: versions
        run: |
          echo "version=4.4" >> $GITHUB_OUTPUT
          echo "v8=v8_12.4.254.21_r13" >> $GITHUB_OUTPUT

      - name: ğŸ± Deps v8
        shell: bash
        env:
          V8: ${{ steps.versions.outputs.v8 }}
        run: |
          curl -L -o "$V8.zip" "https://github.com/ialex32x/GodotJS-Dependencies/releases/download/$V8/$V8.zip"
          unzip "$V8.zip" -d "/tmp/$V8"
          mkdir -p "${{github.workspace}}/modules/GodotJS/"
          mv "/tmp/$V8/v8" "${{github.workspace}}/modules/GodotJS/v8"
          ls "${{github.workspace}}/modules/GodotJS/v8"


      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: V8
          path: ${{github.workspace}}/modules/GodotJS/v8
          retention-days: 10

  android-build:
    name: ğŸ¤– Android
    uses: ./.github/workflows/android_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  ios-build:
    name: ğŸ iOS
    uses: ./.github/workflows/ios_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  linux-build:
    name: ğŸ§ Linux
    uses: ./.github/workflows/linux_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}
      tests: ${{ github.event_name != 'release' }}

  macos-build:
    name: ğŸ macOS
    uses: ./.github/workflows/macos_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}
      tests: ${{ github.event_name != 'release' }}

  windows-build:
    name: ğŸ Windows
    uses: ./.github/workflows/windows_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}
      tests: ${{ github.event_name != 'release' }}

  web-build:
    name: ğŸŒ Web
    uses: ./.github/workflows/web_builds.yml
    needs: environment
    with:
      version: ${{ needs.environment.outputs.version }}

  checks-done:
    if: ${{ always() }}
    name: âœ… Check builds
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ‰ Checks done
        run: |
          resultWebBuild="${{ needs.web-build.result }}"
          resultWindowsBuild="${{ needs.windows-build.result }}"          
          resultMacosBuild="${{ needs.macos-build.result }}"
          resultLinuxBuild="${{ needs.linux-build.result }}"
          resultIosBuild="${{ needs.ios-build.result }}"
          resultAndroidBuild="${{ needs.android-build.result }}"
          if [[ 
            $resultWebBuild == "success" && 
            $resultWindowsBuild == "success" && 
            $resultMacosBuild == "success" && 
            $resultLinuxBuild == "success" && 
            $resultIosBuild == "success" && 
            $resultAndroidBuild == "success" 
          ]]; 
          then
            echo "ğŸ‰ All builds were successful."
            exit 0
          else
            echo "ğŸ˜¥ Some builds were failing."
            exit 1
          fi
    needs:
      [
        web-build,
        windows-build,
        macos-build,
        linux-build,
        ios-build,
        android-build
      ]

  release:
    name: ğŸ¦… Release
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [ checks-done, environment ]
    uses: ./.github/workflows/release_builds.yml
    secrets: inherit
    with:
      version: ${{ needs.environment.outputs.version }}
      v8: ${{ needs.environment.outputs.v8 }}
